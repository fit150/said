name: Upload Model to Release

on:
  workflow_dispatch:
    inputs:
      repo_id:
        description: "HF repo id"
        required: true
        default: "mlx-community/gemma-3-1b-it-4bit"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub[cli]"
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Download + Pack
        run: |
          set -euo pipefail

          REPO_ID="${{ inputs.repo_id }}"
          SAFE_NAME="$(echo "$REPO_ID" | tr '/ ' '..')"

          rm -rf dist
          mkdir -p dist/repo

          hf download "$REPO_ID" --local-dir dist/repo

          # pack real files (dereference symlinks)
          rsync -aL dist/repo/ dist/repo_real/
          rm -rf dist/repo
          mv dist/repo_real dist/repo

          tar -czf "dist/${SAFE_NAME}.tgz" -C dist repo

      - name: Release + Upload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG=huggingface
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n ""

          REPO_ID="${{ inputs.repo_id }}"
          SAFE_NAME="$(echo "$REPO_ID" | tr '/ ' '..')"

          gh release upload "$TAG" "dist/${SAFE_NAME}.tgz" --clobber